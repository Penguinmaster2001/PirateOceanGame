using Godot;
using System;
using System.Collections.Generic;



/*
 * This manages the HexMap
 * It displays hexes generated by the map
 * Eventually it will hide hexes out of range
 * 
 * It also manages clicking on the hexes
 */
public partial class HexGrid : Node3D
{
	private float size_ratio = Mathf.Cos(Mathf.Pi / 6.0f);
	private PackedScene hex_tile = (PackedScene) GD.Load("res://Hex/HexTile.tscn");

	[Export(PropertyHint.Range, "1, 500")]
	private int grid_size;


	private List<Material> hex_materials = new();


	[Signal]
	public delegate void HexSelectedEventHandler(Hex hex);




	public override void _Ready()
	{
		List<string> material_paths = HexTypes.get_type_material_paths();

		foreach (string path in material_paths)
		{
			hex_materials.Add((Material) GD.Load(path));
		}

		HexMap.generate_triangle(grid_size);

		display_map(HexMap.get_collapsed_hexes());

		Connect(SignalName.HexSelected, new Callable(GetNode("/root/Main/FleetController"), nameof(FleetController.on_hex_selection)));
	}



	public override void _Process(double delta)
	{
		if (HexMap.collapsed_all_hexes())
			return;

		ulong start_ms = Time.GetTicksMsec();
		while (Time.GetTicksMsec() - start_ms < 10)
			display_hex(HexMap.collapse_next_hex());
	}



	private void display_map(List<WfcHex> hexes)
	{
		foreach (Hex hex in hexes)
			display_hex(hex);
	}
		


	private void display_hex(Hex hex)
	{
		if (hex == null)
			return;

		Vector3 hex_coords = hex.get_world_coords();

		Node3D display_hex = (Node3D) hex_tile.Instantiate();
		AddChild(display_hex);
		display_hex.Translate(hex_coords);
		
		MeshInstance3D hex_mesh = (MeshInstance3D) display_hex.GetChild(0);
		hex_mesh.MaterialOverride = hex_materials[hex.get_terrain_type()];
	}
	


    public override void _UnhandledInput(InputEvent @event)
    {
		if (@event is InputEventMouseButton eventMouseButton
			&& eventMouseButton.IsPressed()
			&& eventMouseButton.ButtonIndex == MouseButton.Left)
		{
			Camera3D camera = GetViewport().GetCamera3D();

			Vector3 origin = camera.ProjectRayOrigin(eventMouseButton.Position);
			Vector3 direction = camera.ProjectRayNormal(eventMouseButton.Position);

			Vector3 intersection = origin - (direction * origin.Y / direction.Y);

			Hex selected_hex = HexMap.get_hex_at_world_coords(intersection.X, intersection.Z);
			EmitSignal(SignalName.HexSelected, selected_hex);
		}
    }
}
